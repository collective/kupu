<tal:block define="charset here/portal_properties/site_properties/default_charset|here/portal_properties/default_charset|string:utf-8;
        content_type python:request.RESPONSE.setHeader('Content-Type', 'text/xml;;charset=%s' % charset);"
 replace='structure string:&lt;?xml version="1.0" encoding="${charset}" ?&gt;'>
<?xml version="1.0"?>
</tal:block>
<collection
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    tal:define="resource_type request/resource_type | string:mediaobject;
        instance python:request.get('instance', '');
        instance python:test(instance, 'instance=%s&' % instance, '');
        global supportsupload python:resource_type=='mediaobject';"
    >

  <tal:with define="kupu context/kupu_library_tool;
        info python:kupu.getSingleObjectInfo(context);
        breadcrumbs python:kupu.getBreadCrumbs(context);">
    <metal:macro use-macro="here/kupucollection.xml/macros/commonToAllItems" />
    <breadcrumbs tal:condition="breadcrumbs">
      <tal:loop tal:repeat="crumb breadcrumbs">
      <crumb tal:content="crumb/Title"
        tal:define="url crumb/absolute_url; url python:url.rstrip('/');
                href string:${url}/${template/getId}?${instance}resource_type=${resource_type};
                href python:test(repeat['crumb'].end, None, href);"
        tal:attributes="href href"/>
      </tal:loop>
    </breadcrumbs>
  </tal:with>

  <items metal:define-macro="collectionItems">
     <tal:var define="global resource_type request/resource_type | string:mediaobject;" />
     <metal:slot define-slot="defineItems">
       <tal:comment condition="nothing">
         The default resource type is mediaobject
       </tal:comment>
       <tal:var define="kupu context/kupu_library_tool;
        global items python:kupu.getFolderItems(context,resource_type);" />
     </metal:slot>

    <tal:loop repeat="info items">

      <tal:comment condition="nothing">
        We use the URI as ID here, because all resource need to have a
        site-wide unique id
      </tal:comment>

      <resource tal:attributes="id info/id; class info/class|nothing;"
                tal:condition="not:info/collection">
        <metal:macro define-macro="commonToAllItems">
          <uri metal:define-slot="uri"
               tal:content="info/url">URI</uri>
          <icon metal:define-slot="icon"
                tal:content="info/icon">icon</icon>
          <size metal:define-slot="size"
                tal:condition="info/size"
                tal:content="info/size">size</size>
          <tal:block condition="python:info.get('width') and info.get('height')">
              <width metal:define-slot="width"
                     tal:content="info/width">width</width>
              <height metal:define-slot="height"
                     tal:content="info/height">height</height>
          </tal:block>
          <preview metal:define-slot="preview"
                   tal:condition="info/preview"
                   tal:content="info/preview"></preview>
          <status tal:condition="info/state"
                tal:attributes="class info/class" tal:content="info/state" />
          <label metal:define-slot="label"
                tal:condition="info/label|nothing"
                tal:content="info/label">label</label>
          <title metal:define-slot="title"
                 tal:content="info/title">title</title>
          <description metal:define-slot="description"
                       tal:content="structure info/description">description</description>
          <anchor tal:condition="info/anchor|nothing" />
          <src tal:condition="info/src" tal:content="info/src">Source</src>
        </metal:macro>
      </resource>

      <collection tal:attributes="id info/id; linkable info/linkable|nothing;class info/class|nothing"
                  tal:condition="info/collection">
        <metal:insert use-macro="here/kupucollection.xml/macros/commonToAllItems" />
      </collection>

    </tal:loop>
    <uploadbutton tal:condition="supportsupload|nothing" />
  </items>

</collection>
